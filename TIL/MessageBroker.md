# Message Broker에 대하여

# Message Broker에 대하여

## MOM (Message Oriented Middleware)

---

> 애플리케이션의 메세지를 중간에서 관리해주는 시스템
> 

### 장점

- 여러 클라이언트 시스템 간의 메세지 통신을 중간에서 관리
    - 시스템 간의 종속성, 결속성을 낮춰준다.
    - 받는 이의 주소를 몰라도 메세지를 보낼 수 있다.
- 주고 받는 메세지를 데이터베이스에 기록하는 등 백업할 수 있다.
    - 안정성을 높여준다.
- 라우팅 규칙을 적용하여 하나의 메세지로도 특정 여러 클라이언트가 받을 수 있도록 할 수 있다.

### 단점

- 메세지 전체를 관리하는 시스템이 따로 필요 → 도입 비용, 운영 비용 고려
- 전체적인 시스템 구조가 복잡해짐 → 이로 인한 오버헤드 발생 가능

### MOM의 표준/프로토콜 및 구현체

- MOM은 이론, 개념 설계적인 방향성을 제시할 뿐 직접적인 구현체는 아님
- 표준 및 프로토콜
    - Java에서 지원하는 표준 API인 JMS (Java Messaging System)
    - 미들웨어 브로커 간 메세지 교환을 위한 표준 프로토콜
        - AMQP(Advanced Message Queue Protocol)
        - 프로토콜만 일치한다면 다른 AMQP를 사용한 애플리케이션과 통신 가능
- 구현체
    - RabbitMQ
    - Apache Kafka
    - Amazon SQS

## Message Queue 란?

---

> 메세지를 임시로 저장하는 간단한 버퍼
메세지를 전송 및 수신하기 위해 중간에 메세지 큐를 두는 것이다.
> 

![Untitled](Message%20Broker%E1%84%8B%E1%85%A6%20%E1%84%83%E1%85%A2%E1%84%92%E1%85%A1%E1%84%8B%E1%85%A7%207b7588aa331147dba81d7bfbd6310fe5/Untitled.png)

- 생산자(Producer) 컴포넌트가 메세지를 메세지큐에 추가
- 소비자(Consumer) 컴포넌트가 메세지큐에서 메세지를 검색 및 사용
- 메세지는 하나의 소비자에 의해 한 번만 처리 가능 → 일대일 통신

### 메세지 큐를 사용하는 경우

- 일반적인 클라이언트-서버 구조에서는 사용자가 요청하면 서버가 그에 대한 처리를 한 후 클라이언트에게 응답
    - 메세지큐를 사용할 필요가 없음
        - 메세지큐를 사용한다면 HTTP 요청을 바로 처리하지 않기 때문에 사용자가 응답을 기다려야 한다.
- 메세지큐는 소비자가 **실제로 메세지를 어느 시점에 가져가서 처리하는 지 보장하지 않음**
    - 비동기적 특성: 메세지큐에 넣어두면 언젠가는 소비되겠지~ 마인드

<aside>
💡 메세지큐는 즉각적으로 처리되어야 하고, 성공이 보장되어야 하는 핵심 작업보다는 **애플리케이션의 부가적인 기능에 사용하는 것이 적합**

</aside>

![Untitled](Message%20Broker%E1%84%8B%E1%85%A6%20%E1%84%83%E1%85%A2%E1%84%92%E1%85%A1%E1%84%8B%E1%85%A7%207b7588aa331147dba81d7bfbd6310fe5/Untitled%201.png)

- 만약 메세지를 소비하는 속도보다 메세지 큐에 들어오는 속도가 더 빠르다면, 이를 처리하는 소비자 인스턴스를 더 둠으로써 확장이 가능하다.

### 메세지 큐 사용의 이점

************비동기************

- 동기적인 방식에 비해 병목 현상, 응답 지연 현상이 적다.

****************************낮은 결합도****************************

- 생산자 서비스와 소비자 서비스가 독립적으로 행동하게 된다.

**확장성**

- 생산자 서비스와 소비자 서비스를 원하는 대로 확장할 수 있기 때문에 확장성이 좋다.

****************탄력성****************

- 소비자 서비스가 다운되더라도 MQ가 중지되는 것은 아니다.
- 메세지는 여전히 메세지 큐에 남아있으므로 서비스를 다시 시작한 후, 하던 대로 처리하면 된다.

************보장성************

- 큐에 보관되는 모든 메세지는 결국 소비자 서비스에게 전달된다.
- 전달 보장 매커니즘(Guaranteed delivery mechanism)

> **그럼, 만약 메시지 브로커 자체가 죽으면 어떻게 될까요?**
> 
> - 브로커 자체가 죽는다고 송신 및 수신 측 서버에 부담이 가지 않습니다. 메시지 전송의 출구만 없어질 뿐 그 자체의 서버 역할을 하고 있을 것입니다. 하지만 당연히도 메시지 전송 기능 자체에는 문제가 발생할 수 있습니다.
> - 하지만 메시지 브로커 서버는 일반 서버와 달리 메시지 전송과 메시지 큐 부분에만 집중을 둔 서버로서 고가용성을 목표로 만들어져있어 서버가 이상이 있을 위험이 더 적다고 합니다.

### 메세지 큐 사용의 단점

- Queue가 가득 차서 더는 Queue에 메세지를 저장할 수 없는 상황
    - 메세지는 다른 곳에 보존하거나 버려지게 된다.
- Queue를 운영하기 위한 추가적인 자원이 필요하다.
- Queue에 들어가고 나오는 과정에서 오버헤드가 필연적으로 발생하게 된다.

## Message Broker란?

---

![Untitled](Message%20Broker%E1%84%8B%E1%85%A6%20%E1%84%83%E1%85%A2%E1%84%92%E1%85%A1%E1%84%8B%E1%85%A7%207b7588aa331147dba81d7bfbd6310fe5/Untitled%202.png)

- Message Broker는 Publisher(송신자)로부터 전달받은 메세지를 동일한 Topic의 Subscriber(수신자)로 전달해주는 중간 역할을 한다.
- **메세지가 적재되는 공간을 Message Queue**, **메세지의 그룹을 Topic**이라고 한다.
- 대표적으로 Apache Kafka, RabbitMQ, Celery가 있다.

### Message Broker의 활용

**********상황**********

- 실시간으로 데이터가 계속 쌓이는 테이블을 실시간에 가깝게 빠르게 조회해야 하는 상황

**********************************일반적인 방법**********************************

![Untitled](Message%20Broker%E1%84%8B%E1%85%A6%20%E1%84%83%E1%85%A2%E1%84%92%E1%85%A1%E1%84%8B%E1%85%A7%207b7588aa331147dba81d7bfbd6310fe5/Untitled%203.png)

- 조회 성능을 높이기 위해 index를 건다.
    - 반대로 insert 속도가 느려지기 때문에 실시간 처리에는 적합하지 않다.

************************************************************Message Broker를 사용한 방법************************************************************

![Untitled](Message%20Broker%E1%84%8B%E1%85%A6%20%E1%84%83%E1%85%A2%E1%84%92%E1%85%A1%E1%84%8B%E1%85%A7%207b7588aa331147dba81d7bfbd6310fe5/Untitled%204.png)

- A서버는 데이터를 Message Queue에 적재
    - 별도의 조회 과정 없음
- 메세지가 적재되면 A서버가 조회
- 장점
    - 실시간 데이터 처리 시, DB에서 조회하여 처리하는 것보다 성능이 좋다.
- 단점
    - DB처럼 원하는 데이터만 필터링하여 조회할 수 없고, 적재된 데이터를 그대로 사용해야 한다.
        - 필터링 된 데이터를 적재하던가, 적재된 데이터를 Logstash 등의 데이터 수집 툴을 이용하여 필터링해야 한다.
    - 장기적인 보관이 힘들다.
        - 보통 7일 정도 보관
        - 장기적인 보관을 위해 별도의 저장소를 둘 수 있다.

## Ref

---

[메세지 큐에 대해 알아보자!](https://tecoble.techcourse.co.kr/post/2021-09-19-message-queue/)

[Message Broker(메시지브로커) 및 Message Queue(메시지큐) 정리](https://dev-jwblog.tistory.com/140)

[[Tech.] Message Broker란?](https://heodolf.tistory.com/49)

[**Message Broker - 왜 사용하는 것일까 ?](https://binux.tistory.com/74) - 꼭 읽어보길 추천**